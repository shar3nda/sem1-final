name: Go Test Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - name: Set short git commit SHA
        run: |
          calculatedSha=$(git rev-parse --short ${{ github.sha }})
          echo "COMMIT_SHORT_SHA=$calculatedSha" >> $GITHUB_ENV

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Prepare environment
        id: prepare
        run: ./scripts/prepare.sh
        env:
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          IMAGE_NAME: ${{ vars.IMAGE_NAME }}
          TAG: ${{ env.COMMIT_SHORT_SHA }}

      - name: Create .env for Docker Deploy
        run: |
          cat > .env <<EOF
          DB_HOST=db
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          EOF

      - name: Install yc
        uses: lxhan/yc-install@v3

      - name: Run application
        id: run
        run: ./scripts/run.sh
        env:
          API_HOST: ${{ env.API_HOST }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: 5432
          DB_DB: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - run: |
          echo "Deployed server to ${API_HOST}"

      - name: Test Level 1
        id: test-level-1
        continue-on-error: true
        run: ./scripts/tests.sh 1
        env:
          API_HOST: ${{ env.API_HOST }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: 5432
          DB_DB: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Test Level 2
        id: test-level-2
        continue-on-error: true
        run: ./scripts/tests.sh 2
        env:
          API_HOST: ${{ env.API_HOST }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: 5432
          DB_DB: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Test Level 3
        id: test-level-3
        continue-on-error: true
        run: ./scripts/tests.sh 3
        env:
          API_HOST: ${{ env.API_HOST }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: 5432
          DB_DB: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Check test results
        if: always()
        run: |
          if [[ "${{ steps.test-level-1.outcome }}" == "success" ]] || \
             [[ "${{ steps.test-level-2.outcome }}" == "success" ]] || \
             [[ "${{ steps.test-level-3.outcome }}" == "success" ]]; then
            echo "At least one test level passed successfully!"
            exit 0
          else
            echo "All test levels failed!"
            exit 1
          fi
